<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دعوة خاصة</title>

    <!-- React and Babel for JSX in browser -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts for branding -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cardo:wght@700&family=Cairo:wght@400;600;700&display=swap"
        rel="stylesheet">

    <style>
        .font-cardo {
            font-family: 'Cardo', serif;
        }

        .font-cairo {
            font-family: 'Cairo', sans-serif;
        }

        body {
            background-color: #f1f2f2;
        }

        .loader {
            border-top-color: #15a9b2;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
    </style>
</head>

<body class="bg-[#f1f2f2]">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const translations = {
            ar: {
                title: 'دعوة خاصة',
                formTitle: 'دعوة خاصة',
                formTitleFrom: '',
                formSubtitle: 'الرجاء إدخال تفاصيل المرشح في النموذج أدناه.',
                firstName: 'الاسم الأول',
                lastName: 'الاسم الأخير',
                email: 'البريد الإلكتروني',
                phoneNumber: 'رقم الهاتف',
                position: 'الوظيفة',
                institute: 'المؤسسة/الشركة',
                country: 'البلد',
                required: 'مطلوب',
                registerButton: 'تسجيل',
                loadingButton: 'جاري التسجيل...',
                errorTitle: 'خطأ',
                errorRequired: 'الرجاء ملء جميع الحقول الإلزامية.',
                errorConflict: 'مرشح بنفس البريد الإلكتروني أو رقم الهاتف موجود بالفعل.',
                errorGeneric: 'فشل إضافة المرشح. يرجى المحاولة لاحقاً.',
                errorConnection: 'فشل الاتصال بالخادم. يرجى التحقق من اتصالك بالإنترنت.',
                errorInvalidToken: 'رابط التسجيل غير صالح. الرجاء التأكد من الرابط الصحيح.',
                successTitle: 'نجاح',
                successMessage: 'تم التسجيل بنجاح!',
                successGreeting: `شكرًا للتسجيل! \nنتطلع إلى لقائكم في "حفل الاستقبال السنوي للغرفة الإسلامية" يوم الأحد الموافق 14 سبتمبر 2025، في تمام الساعة 5 مساءً، بقاعة ماجنيتا - فندق فيرمونت نايل سيتي - القاهرة. \n\nللمزيد من التفاصيل، يُرجى التواصل عبر:\nت: ‪(+2) 01100409669‬\n  ‪(+2) 01004816779`,
                closeButton: 'إغلاق',
                confirmTitle: 'حفل الاستقبال السنوي للغرفة الإسلامية',
                eventDetails: `يوم الأحد الموافق 14 سبتمبر 2025، في تمام الساعة 5 مساءً،\nبقاعة ماجنيتا - فندق فيرمونت نايل سيتي - القاهرة.\n\nللمزيد من التفاصيل، يُرجى التواصل عبر:\nت: ‪(+2) 01100409669‬\n  ‪(+2) 01004816779`,
                confirmButton: 'قبول الدعوة',
                cancelButton: 'رفض الدعوة',
                cancelMessageTitle: 'شكراً لك.',
                cancelMessageSubtitle: 'نأمل أن نراك في أحداثنا المستقبلية.',
                combinedTitle: 'دعوة خاصة لحضور حفل الاستقبال السنوي للغرفة الاسلامية'
            },
            en: {
                title: 'Special Invitation',
                formTitle: 'Special Invitation',
                formTitleFrom: '',
                formSubtitle: "Please enter the candidate's details in the form below.",
                firstName: 'First Name',
                lastName: 'Last Name',
                email: 'Email',
                phoneNumber: 'Phone Number',
                position: 'Position',
                institute: 'Institute/Company',
                country: 'Country',
                required: 'Required',
                registerButton: 'Register',
                loadingButton: 'Registering...',
                errorTitle: 'Error',
                errorRequired: 'Please fill in all required fields.',
                errorConflict: 'A candidate with the same email or phone number already exists.',
                errorGeneric: 'Failed to add candidate. Please try again later.',
                errorConnection: 'Failed to connect to the server. Please check your internet connection.',
                errorInvalidToken: 'Invalid registration link. Please make sure the link is correct.',
                successTitle: 'Success',
                successMessage: 'Registered Successfully!',
                successGreeting: `Thank you for your registration. We look forward to welcoming you to "ICCD Annual Reception" on Sunday, September 14, 2025, at 5:00 PM, at the Magenta Ballroom, Fairmont Nile City Hotel, Cairo\n\nEntry is available exclusively via QR code.\n\nFor more details, please contact:\nTel: ‪(+2) 01100409669‬\n      ‪(+2) 01004816779`,
                closeButton: 'Close',
                confirmTitle: 'ICCD Annual Reception',
                eventDetails: `Sunday, September 14, 2025, at 5:00 PM,\nat the Magenta Ballroom, Fairmont Nile City Hotel, Cairo.\n\nFor more details, please contact:\nTel: ‪(+2) 01100409669‬\n      ‪(+2) 01004816779`,
                confirmButton: 'Accept Invitation',
                cancelButton: 'Decline Invitation',
                cancelMessageTitle: 'Thank you.',
                cancelMessageSubtitle: 'We hope to see you at our future events.',
                combinedTitle: 'Special Invitation to the ICCD Annual Reception'
            },
            fr: {
                title: 'Invitation Spéciale',
                formTitle: 'Invitation Spéciale',
                formTitleFrom: '',
                formSubtitle: 'Veuillez saisir les informations du candidat dans le formulaire ci-dessous.',
                firstName: 'Prénom',
                lastName: 'Nom',
                email: 'Email',
                phoneNumber: 'Numéro de téléphone',
                position: 'Poste',
                institute: 'Institut/Entreprise',
                country: 'Pays',
                required: 'Requis',
                registerButton: 'S\'inscrire',
                loadingButton: 'Inscription en cours...',
                errorTitle: 'Erreur',
                errorRequired: 'Veuillez remplir tous les champs obligatoires.',
                errorConflict: 'Un candidat avec le même email ou numéro de téléphone existe déjà.',
                errorGeneric: 'Échec de l\'ajout du candidat. Veuillez réessayer plus tard.',
                errorConnection: 'La connexion au serveur a échoué. Veuillez vérifier votre connexion Internet.',
                errorInvalidToken: 'Lien d\'inscription invalide. Veuillez vous assurer que le lien est correct.',
                successTitle: 'Succès',
                successMessage: 'Inscription réussie !',
                successGreeting: `Merci pour votre inscription. Nous nous réjouissons de vous accueillir à « la Réception Annuelle de la CICD », qui aura lieu le dimanche 14 septembre 2025 à 17h00, à la salle « Magenta Ballroom » de l’Hôtel de Fairmont Nile City, au Caire.\n\nL'entrée est disponible exclusivement via QR code.\n\nPour en savoir plus, veuillez contacter :\nTél : ‪(+2) 01100409669‬\n       ‪(+2) 01004816779`,
                closeButton: 'Fermer',
                confirmTitle: 'Réception Annuelle de la CICD',
                eventDetails: `Le dimanche 14 septembre 2025 à 17h00,\nà la salle « Magenta Ballroom » de l’Hôtel de Fairmont Nile City, au Caire.\n\nPour en savoir plus, veuillez contacter :\nTél : ‪(+2) 01100409669‬\n       ‪(+2) 01004816779`,
                confirmButton: 'J\'accepte',
                cancelButton: 'Je décline',
                cancelMessageTitle: 'Merci.',
                cancelMessageSubtitle: 'Nous espérons vous voir lors de nos prochains événements.',
                combinedTitle: 'Invitation Spéciale à la Réception Annuelle de la CICD'
            }
        };

        const App = () => {
            const [language, setLanguage] = useState('ar');
            const [formData, setFormData] = useState({
                firstName: '',
                lastName: '',
                position: '',
                institute: '',
                country: '',
                phoneNumber: '',
                email: '',
                language: 'ar'
            });

            const [instituteData, setInstituteData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState({ text: '', type: '' });
            const [showModal, setShowModal] = useState(false);
            const [apiBaseUrl, setApiBaseUrl] = useState('https://registrationiccdglobal01-ejajdmdja6d8dng4.southafricanorth-01.azurewebsites.net');
            const [pageLoading, setPageLoading] = useState(true);
            const [showConfirmation, setShowConfirmation] = useState(true);
            const [showCancelledMessage, setShowCancelledMessage] = useState(false);
            const [registrationSuccess, setRegistrationSuccess] = useState(false);

            useEffect(() => {
                const browserLang = navigator.language.split('-')[0];
                const newLang = ['ar', 'en', 'fr'].includes(browserLang) ? browserLang : 'en';
                changeLanguage(newLang);

                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token');

                if (token) {
                    fetchInstituteData(token);
                } else {
                    setPageLoading(false);
                }
            }, []);
            
            const changeLanguage = (lang) => {
                setLanguage(lang);
                setFormData(prev => ({ ...prev, language: lang }));
                document.documentElement.lang = lang;
                document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
                document.body.style.textAlign = lang === 'ar' ? 'right' : 'left';
                document.title = translations[lang].title;
            };

            const t = (key) => translations[language][key] || key;
            
            const fetchInstituteData = async (token) => {
                setPageLoading(true);
                try {
                    const response = await fetch(`${apiBaseUrl}/api/candidates/register/${token}`);
                    const result = await response.json();

                    if (response.ok && result.status === 'SUCCESS') {
                        setInstituteData(result.data);
                        setFormData(prev => ({
                            ...prev,
                            institute: result.data.institute_name,
                            instituteId: result.data.institute_id
                        }));
                    } else {
                        console.error('Failed to fetch institute data:', result.message);
                        showCustomModal(t('errorTitle'), t('errorInvalidToken'), 'error');
                    }
                } catch (error) {
                    console.error('Error fetching institute data:', error);
                    showCustomModal(t('errorTitle'), t('errorConnection'), 'error');
                } finally {
                    setPageLoading(false);
                }
            };

            const handleConfirm = () => setShowConfirmation(false);
            const handleCancel = () => { setShowConfirmation(false); setShowCancelledMessage(true); };
            const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value })); };
            const showCustomModal = (title, msg, type) => { setMessage({ text: msg, type }); setShowModal(true); };
            const closeModal = () => { setShowModal(false); setMessage({ text: '', type: '' }); };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);

                const { firstName, lastName, phoneNumber, email } = formData;
                if (!firstName || !lastName || !phoneNumber || !email) {
                    showCustomModal(t('errorTitle'), t('errorRequired'), 'error');
                    setLoading(false);
                    return;
                }

                try {
                    const response = await fetch(`${apiBaseUrl}/api/candidates`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();

                    if (response.status === 201) {
                        setRegistrationSuccess(true);
                    } else if (response.status === 409) {
                        showCustomModal(t('errorTitle'), t('errorConflict'), 'error');
                    } else if (response.status === 400) {
                        showCustomModal(t('errorTitle'), result.message, 'error');
                    } else {
                        showCustomModal(t('errorTitle'), t('errorGeneric'), 'error');
                    }
                } catch (error) {
                    console.error('Error submitting form:', error);
                    showCustomModal(t('errorTitle'), t('errorConnection'), 'error');
                } finally {
                    setLoading(false);
                }
            };
            
            const LanguageSwitcher = () => (
                <div className="flex justify-center items-center space-x-4 mb-4">
                    {['ar', 'en', 'fr'].map(lang => (
                        <button
                            key={lang}
                            onClick={() => changeLanguage(lang)}
                            className={`px-4 py-2 rounded-lg text-sm font-bold transition-colors ${language === lang ? 'bg-[#15a9b2] text-white' : 'bg-white text-gray-700 hover:bg-gray-200'}`}
                        >
                            {lang.toUpperCase()}
                        </button>
                    ))}
                </div>
            );

            const CustomModal = ({ title, message, type, onClose }) => {
                const titleColor = type === 'success' ? 'text-green-600' : 'text-red-600';
                const buttonColor = type === 'success' ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600';

                return (
                    <div className="fixed inset-0 flex items-center justify-center z-50 modal-overlay">
                        <div className="bg-white rounded-xl shadow-xl p-8 w-full max-w-sm">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className={`text-xl font-bold ${titleColor}`}>{title}</h3>
                                <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
                                    <i className="fas fa-times"></i>
                                </button>
                            </div>
                            <p className="text-gray-700 mb-6">{message}</p>
                            <div className={language === 'ar' ? "text-left" : "text-right"}>
                                <button
                                    onClick={onClose}
                                    className={`px-6 py-2 text-white rounded-lg transition-colors ${buttonColor}`}
                                >
                                    {t('closeButton')}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderContent = () => {
                if (pageLoading) {
                    return (
                        <div className="flex items-center justify-center p-12">
                            <div className="loader ease-linear rounded-full border-4 border-t-4 border-[#15a9b2] h-12 w-12"></div>
                        </div>
                    );
                }

                if (registrationSuccess) {
                    return (
                        <div className="text-center p-6 sm:p-12">
                            <i className="fas fa-check-circle text-green-500 text-6xl mb-4"></i>
                            <h1 className="text-2xl font-bold text-[#1b2a39] font-cardo mb-4">
                                {t('successMessage')}
                            </h1>
                            <p className="text-gray-600 font-cairo whitespace-pre-line">
                                {t('successGreeting')}
                            </p>
                        </div>
                    );
                }
                
                if (showConfirmation) {
                    return (
                        <div className="text-center">
                            <h1 className="text-2xl font-bold text-[#1b2a39] font-cardo mb-4">{t('combinedTitle')}</h1>
                            <p className="text-gray-600 font-cairo mb-4 whitespace-pre-line">{t('eventDetails')}</p>
                            <div className={`flex justify-center space-x-4 ${language === 'ar' ? 'space-x-reverse' : ''}`}>
                                <button
                                    onClick={handleConfirm}
                                    className="px-6 py-3 bg-[#15a9b2] text-white rounded-lg font-bold hover:bg-[#0f7a81] transition-colors"
                                >
                                    {t('confirmButton')}
                                </button>
                                <button
                                    onClick={handleCancel}
                                    className="px-6 py-3 bg-gray-300 text-gray-800 rounded-lg font-bold hover:bg-gray-400 transition-colors"
                                >
                                    {t('cancelButton')}
                                </button>
                            </div>
                        </div>
                    );
                }

                if (showCancelledMessage) {
                    return (
                        <div className="text-center p-12">
                            <h1 className="text-2xl font-bold text-[#1b2a39] font-cardo mb-4">
                                {t('cancelMessageTitle')}
                            </h1>
                            <p className="text-gray-600 font-cairo">
                                {t('cancelMessageSubtitle')}
                            </p>
                        </div>
                    );
                }

                return (
                    <>
                        <h1 className="text-2xl font-bold text-[#1b2a39] text-center font-cardo mb-2">
                           {t('formTitle')}
                        </h1>
                        <p className="text-gray-600 text-center font-cairo mb-8">
                            {t('formSubtitle')}
                        </p>
                        <form onSubmit={handleSubmit} className="space-y-4 font-cairo">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label htmlFor="firstName" className="block text-sm font-medium text-gray-700">{t('firstName')} <span className="text-red-500">*</span></label>
                                    <input type="text" id="firstName" name="firstName" value={formData.firstName} onChange={handleChange} className="mt-1 p-3 w-full border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#15a9b2] outline-none" />
                                </div>
                                <div>
                                    <label htmlFor="lastName" className="block text-sm font-medium text-gray-700">{t('lastName')} <span className="text-red-500">*</span></label>
                                    <input type="text" id="lastName" name="lastName" value={formData.lastName} onChange={handleChange} className="mt-1 p-3 w-full border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#15a9b2] outline-none" />
                                </div>
                            </div>
                            <div>
                                <label htmlFor="email" className="block text-sm font-medium text-gray-700">{t('email')} <span className="text-red-500">*</span></label>
                                <input type="email" id="email" name="email" value={formData.email} onChange={handleChange} className="mt-1 p-3 w-full border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#15a9b2] outline-none" />
                            </div>
                            <div>
                                <label htmlFor="phoneNumber" className="block text-sm font-medium text-gray-700">{t('phoneNumber')} <span className="text-red-500">*</span></label>
                                <input type="tel" id="phoneNumber" name="phoneNumber" value={formData.phoneNumber} onChange={handleChange} className="mt-1 p-3 w-full border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#15a9b2] outline-none" />
                            </div>
                            <div>
                                <label htmlFor="position" className="block text-sm font-medium text-gray-700">{t('position')}</label>
                                <input type="text" id="position" name="position" value={formData.position} onChange={handleChange} className="mt-1 p-3 w-full border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#15a9b2] outline-none" />
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label htmlFor="institute" className="block text-sm font-medium text-gray-700">{t('institute')}</label>
                                    <input 
                                        type="text" 
                                        id="institute" 
                                        name="institute" 
                                        value={formData.institute} 
                                        onChange={handleChange} 
                                        className="mt-1 p-3 w-full border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#15a9b2] outline-none bg-gray-100" 
                                        disabled={!!instituteData}
                                    />
                                </div>
                                <div>
                                    <label htmlFor="country" className="block text-sm font-medium text-gray-700">{t('country')}</label>
                                    <input type="text" id="country" name="country" value={formData.country} onChange={handleChange} className="mt-1 p-3 w-full border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#15a9b2] outline-none" />
                                </div>
                            </div>
                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full bg-[#15a9b2] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#0f7a81] transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                            >
                                {loading ? (
                                    <div className="loader ease-linear rounded-full border-2 border-t-2 border-gray-200 h-6 w-6 mx-auto"></div>
                                ) : (
                                    t('registerButton')
                                )}
                            </button>
                        </form>
                    </>
                );
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-4 font-cairo">
                    <LanguageSwitcher />
                    <div className="bg-white p-8 rounded-xl shadow-lg border border-gray-200 w-full max-w-lg">
                        <div className="w-45 mb-6 justify-center mx-auto">
                            <div className="rounded-xl w-full h-full flex items-center justify-center text-gray-500 text-sm">
                                <img src="images/ICCD-Logo-02.png" alt="ICCD Logo" className="w-full h-auto rounded-xl object-contain" />
                            </div>
                        </div>
                        {renderContent()}
                    </div>
                    {showModal && (
                        <CustomModal
                            title={message.type === 'success' ? t('successTitle') : t('errorTitle')}
                            message={message.text}
                            type={message.type}
                            onClose={closeModal}
                        />
                    )}
                </div>
            );
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>

</html>
